(function($){$('body').on('submit','.gamipress-points-exchanges-form',function(e){e.preventDefault();return!1});$('body').on('keypress','.gamipress-points-exchanges-form',function(e){return e.keyCode!=13});$('body').on('click','.gamipress-points-exchanges-form .gamipress-points-exchanges-form-submit-button',function(e){e.preventDefault();var $this=$(this);var form=$(this).closest('.gamipress-points-exchanges-form');var submit_wrap=form.find('.gamipress-points-exchanges-form-submit');if(submit_wrap.find('.gamipress-points-exchanges-form-response').length===0)
submit_wrap.prepend('<div class="gamipress-points-exchanges-form-response" style="display: none;"></div>')
var response_wrap=submit_wrap.find('.gamipress-points-exchanges-form-response');$this.prop('disabled',!0);if(response_wrap.length){response_wrap.slideUp()}
submit_wrap.find('.gamipress-spinner').show();$.ajax({url:gamipress_points_exchanges.ajaxurl,method:'POST',data:form.serialize()+'&action=gamipress_points_exchanges_process_exchange',success:function(response){response_wrap.addClass('gamipress-points-exchanges-'+(response.success===!0?'success':'error'));response_wrap.html((response.data.message!==undefined?response.data.message:response.data));response_wrap.slideDown();if(response.success!==!0)
$this.prop('disabled',!1);submit_wrap.find('.gamipress-spinner').hide()},error:function(response){response_wrap.addClass('gamipress-points-exchanges-error');response_wrap.html('The server has returned an internal error.');response_wrap.slideDown();$this.prop('disabled',!1);submit_wrap.find('.gamipress-spinner').hide()}})});function gamipress_points_exchanges_update_points_balances(form){var amount=form.find('input[name="amount"]').val();var from=form.find('input[name="from"]').val();var to=form.find('input[name="to"]').val();if(from!==''){var from_balance=gamipress_points_exchanges_get_user_points_balance(from);var from_new_balance=parseInt(from_balance-amount);var from_label=gamipress_points_exchanges_get_points_type_label(from);form.find('.gamipress-points-exchanges-form-from-details-label').html(from_label);form.find('.gamipress-points-exchanges-form-from-current-balance-amount').html(from_balance);form.find('.gamipress-points-exchanges-form-from-current-balance-points-label').html(from_label);form.find('.gamipress-points-exchanges-form-from-new-balance-amount').html(from_new_balance);form.find('.gamipress-points-exchanges-form-from-new-balance-points-label').html(from_label);form.find('.gamipress-points-exchanges-form-from-amount-amount').html(amount);form.find('.gamipress-points-exchanges-form-from-amount-points-label').html(from_label);if(from_new_balance>1){form.find('.gamipress-points-exchanges-form-from-new-balance-amount').removeClass('gamipress-points-exchanges-negative').addClass('gamipress-points-exchanges-positive')}else{form.find('.gamipress-points-exchanges-form-from-new-balance-amount').removeClass('gamipress-points-exchanges-positive').addClass('gamipress-points-exchanges-negative')}
form.find('.gamipress-points-exchanges-form-from-details').show()}else{form.find('.gamipress-points-exchanges-form-from-details').hide()}
if(to!==''){var to_balance=gamipress_points_exchanges_get_user_points_balance(to);var to_amount=gamipress_points_exchanges_apply_rate(amount,from,to);var to_new_balance=to_balance+to_amount;var to_label=gamipress_points_exchanges_get_points_type_label(to);form.find('.gamipress-points-exchanges-form-to-details-label').html(to_label);form.find('.gamipress-points-exchanges-form-to-current-balance-amount').html(to_balance);form.find('.gamipress-points-exchanges-form-to-current-balance-points-label').html(to_label);form.find('.gamipress-points-exchanges-form-to-new-balance-amount').html(to_new_balance);form.find('.gamipress-points-exchanges-form-to-new-balance-points-label').html(to_label);form.find('.gamipress-points-exchanges-form-to-amount-amount').html(to_amount);form.find('.gamipress-points-exchanges-form-to-amount-points-label').html(to_label);form.find('.gamipress-points-exchanges-form-to-details').show()}else{form.find('.gamipress-points-exchanges-form-to-details').hide()}
if(from!==''&&to!==''){var rate=gamipress_points_exchanges_get_rate(from,to);form.find('.gamipress-points-exchanges-form-exchange-rate-from-label').html(from_label);form.find('.gamipress-points-exchanges-form-exchange-rate-to-amount').html(rate);form.find('.gamipress-points-exchanges-form-exchange-rate-to-label').html(to_label);form.find('.gamipress-points-exchanges-form-exchange-rate').show();form.find('.gamipress-points-exchanges-form-exchange-rate-error').hide()}else{form.find('.gamipress-points-exchanges-form-exchange-rate').hide();form.find('.gamipress-points-exchanges-form-exchange-rate-error').show()}}
$('body').on('change keyup','.gamipress-points-exchanges-form-amount-input',function(){var form=$(this).closest('.gamipress-points-exchanges-form');var amount=parseInt($(this).val());if(isNaN(amount)){amount=0}
form.find('input[name="amount"]').val(amount);gamipress_points_exchanges_update_points_balances(form)})
$('body').on('change','.gamipress-points-exchanges-form-from-select',function(){var form=$(this).closest('.gamipress-points-exchanges-form');var from=$(this).val();var to_input=form.find('.gamipress-points-exchanges-form-to-select');var to=to_input.val();var to_default=to_input.find('option[value=""]').text();var options_html='<option value="">'+to_default+'</option>';form.find('input[name="from"]').val(from);var rates=gamipress_points_exchanges_get_points_type_exchange_rates(from);$.each(rates,function(points_type,rate){if(parseFloat(rate)!==0){options_html+='<option value="'+points_type+'">'+gamipress_points_exchanges_get_points_type_label(points_type)+'</option>'}});to_input.html(options_html);if(to_input.find('option[value="'+to+'"]').length){to_input.val(to)}else{to_input.val('').trigger('change')}
gamipress_points_exchanges_update_points_balances(form)});$('body').on('change','.gamipress-points-exchanges-form-to-select',function(){var form=$(this).closest('.gamipress-points-exchanges-form');var to=$(this).val();form.find('input[name="to"]').val(to);gamipress_points_exchanges_update_points_balances(form)})})(jQuery)