!function(RPBChessboard,kokopu,$,sanitizeHtml){"use strict";$.chessgame={navigationFrameOptions:{},navigationFrameClass:"",navigationButtonClass:"",chessFont:"alpha",i18n:{ANNOTATED_BY:"Annotated by %1$s",INITIAL_POSITION:"Initial position",PIECE_SYMBOLS:{K:"K",Q:"Q",R:"R",B:"B",N:"N",P:"P"},GO_FIRST_MOVE_TOOLTIP:"Go to the beginning of the game",GO_PREVIOUS_MOVE_TOOLTIP:"Go to the previous move",GO_NEXT_MOVE_TOOLTIP:"Go to the next move",GO_LAST_MOVE_TOOLTIP:"Go to the end of the game",FLIP_TOOLTIP:"Flip the board",DOWNLOAD_PGN_TOOLTIP:"Download the game",PGN_DOWNLOAD_ERROR_MESSAGE:"Cannot download the PGN file.",PGN_PARSING_ERROR_MESSAGE:"Error while analysing a PGN string."}};var dynamicURL=null;function formatResult(result){switch(result){case"1/2-1/2":return"½–½";case"1-0":return"1–0";case"0-1":return"0–1";default:return result}}var SPECIAL_NAGS_LOOKUP={3:"!!",1:"!",5:"!?",6:"?!",2:"?",4:"??",18:"+−",16:"±",14:"⩲",10:"=",11:"=",15:"⩱",17:"∓",19:"−+",7:"□",8:"□",13:"∞",22:"⨀",32:"⟳",36:"↑",40:"→",132:"⇆",138:"⊕",140:"∆",142:"⌓",146:"N"};function sanitizeRichText(text){return sanitizeHtml(text,{allowedTags:["a","b","br","code","em","i","span","strong","sub","sup"],allowedAttributes:{"*":["class","id","title"],a:["href","target"]}})}function filterBoolean(value,defaultValue){return"boolean"==typeof value?value:"number"==typeof value?Boolean(value):"string"==typeof value?"true"===(value=value.toLowerCase())||"1"===value||"on"===value||"false"!==value&&"0"!==value&&"off"!==value&&defaultValue:defaultValue}function filterNavigationBoard(value){switch(value){case"frame":case"floatLeft":case"floatRight":case"scrollLeft":case"scrollRight":case"above":case"below":return value;default:return"none"}}function filterChessboardOptions(value){var result={};return void 0!==value.flip&&(result.flip=value.flip),void 0!==value.squareSize&&(result.squareSize=value.squareSize),void 0!==value.showCoordinates&&(result.showCoordinates=value.showCoordinates),void 0!==value.colorset&&(result.colorset=value.colorset),void 0!==value.pieceset&&(result.pieceset=value.pieceset),void 0!==value.animated&&(result.animated=value.animated),void 0!==value.showMoveArrow&&(result.showMoveArrow=value.showMoveArrow),result}function initializeURL(widget,url){return"string"!=typeof url||""===url?"":(widget.options.pgn="",widget._game=null,$.get(url).done(function(data){widget.options.pgn=initializePGN(widget,data),refresh(widget)}).fail(function(){widget._game={title:$.chessgame.i18n.PGN_DOWNLOAD_ERROR_MESSAGE,message:url},refresh(widget)}),url)}function initializePGN(widget,pgn){pgn=(pgn="string"!=typeof pgn?"*":pgn).replace(/^\s+|\s+$/g,"");try{widget._game=kokopu.pgnRead(pgn,widget.options.gameIndex)}catch(error){if(!(error instanceof kokopu.exception.InvalidPGN))throw widget._game=null,error;widget._game=error}return pgn}function initializePieceSymbols(widget,pieceSymbols){var FIELDS=["K","Q","R","B","N","P"];if(/^\([a-zA-Z]{6}\)$/.test(pieceSymbols)){pieceSymbols=pieceSymbols.toUpperCase(),widget._pieceSymbolTable={};for(var k=0;k<6;++k)widget._pieceSymbolTable[FIELDS[k]]=pieceSymbols.substr(k+1,1)}else switch(pieceSymbols){case"figurines":widget._pieceSymbolTable={};for(var font=function(font){switch(font){case"merida":case"pirat":return font;default:return"alpha"}}($.chessgame.chessFont),k=0;k<6;++k){var field=FIELDS[k];widget._pieceSymbolTable[field]='<span class="rpbui-chessgame-'+font+'Font">'+field+"</span>"}break;case"localized":widget._pieceSymbolTable={};for(k=0;k<6;++k){field=FIELDS[k];widget._pieceSymbolTable[field]=field in $.chessgame.i18n.PIECE_SYMBOLS?$.chessgame.i18n.PIECE_SYMBOLS[field]:field}break;default:widget._pieceSymbolTable={K:"K",Q:"Q",R:"R",B:"B",N:"N",P:"P"},pieceSymbols="native"}return pieceSymbols}function stopScrollAreaSizeTimer(widget){null!==widget._scrollAreaSizeTimerId&&(clearInterval(widget._scrollAreaSizeTimerId),widget._scrollAreaSizeTimerId=null)}function destroyContent(widget){stopScrollAreaSizeTimer(widget),0!==$("#rpbui-chessgame-navigationFrameTarget",widget.element).length&&$("#rpbui-chessgame-navigationFrame").dialog("close"),widget.element.empty()}function refresh(widget){if(destroyContent(widget),null!==widget._game)if(widget._game instanceof kokopu.Game){var fragment=document.createDocumentFragment();fragment.appendChild(function(widget){var result=buildTextElement("div","rpbui-chessgame-move rpbui-chessgame-initialMove",$.chessgame.i18n.INITIAL_POSITION);return insertPositionInformation(result,widget._game.mainVariation(),!0),result}(widget)),fragment.appendChild(function(){var focusField=buildElement("a","rpbui-chessgame-focusField");focusField.setAttribute("href","#");var result=buildElement("div","rpbui-chessgame-focusFieldContainer");return result.appendChild(focusField),result}());var insertionPoint=fragment;switch(widget.options.navigationBoard){case"floatLeft":case"floatRight":case"above":fragment.appendChild(buildNavigationBox(widget));break;case"scrollLeft":case"scrollRight":var insertionPoint=buildElement("div","rpbui-chessgame-scrollArea"),scrollBox=buildElement("div","rpbui-chessgame-scrollBox");scrollBox.appendChild("scrollLeft"===widget.options.navigationBoard?buildNavigationBox(widget):insertionPoint),scrollBox.appendChild("scrollLeft"===widget.options.navigationBoard?insertionPoint:buildNavigationBox(widget)),fragment.appendChild(scrollBox)}var currentHeight=function(result){var whitePlayer=buildPlayerNameHeader(result,"w"),blackPlayer=buildPlayerNameHeader(result,"b"),event=function(round){var header=round._game.event();if(void 0===header)return!1;round=round._game.round(),header=buildRichTextElement("div","rpbui-chessgame-event",header);void 0!==round&&header.appendChild(buildRichTextElement("span","rpbui-chessgame-round",round));return header}(result),datePlace=function(widget){var date=widget._game.date(),site=widget._game.site();if(void 0===date&&void 0===site)return!1;var header=buildElement("div","rpbui-chessgame-datePlaceGroup");void 0!==date&&header.appendChild(buildRichTextElement("span","rpbui-chessgame-date",function(text){return 0===text.length?"":text.charAt(0).toUpperCase()+text.slice(1)}(widget._game.dateAsString())));void 0!==site&&header.appendChild(buildRichTextElement("span","rpbui-chessgame-site",site));return header}(result),annotator=function(annotator){annotator=annotator._game.annotator();return void 0!==annotator&&buildRichTextElement("div","rpbui-chessgame-annotator",$.chessgame.i18n.ANNOTATED_BY.replace(/%1\$s/g,'<span class="rpbui-chessgame-annotatorName">'+annotator+"</span>"))}(result);{if(whitePlayer||blackPlayer||event||datePlace||annotator){result=buildElement("div","rpbui-chessgame-headers");return whitePlayer&&result.appendChild(whitePlayer),blackPlayer&&result.appendChild(blackPlayer),event&&result.appendChild(event),datePlace&&result.appendChild(datePlace),annotator&&result.appendChild(annotator),result}return!1}}(widget);currentHeight&&insertionPoint.appendChild(currentHeight);currentHeight=function(widget){var mainVariation=function buildVariation(widget,variation,isMainVariation,gameResult){if(void 0===variation.comment()&&void 0===variation.first()&&"*"===gameResult)return!1;var variationClass="rpbui-chessgame-variation"+(isMainVariation?"":" rpbui-chessgame-subVariation");var result=buildElement(variation.isLongVariation()?"div":"span",variationClass);var enableMoveGroups=variation.isLongVariation();var moveGroupOpened=!1;var insertionPoint=result;function openMoveGroup(){enableMoveGroups&&!moveGroupOpened&&(insertionPoint=buildElement("div","rpbui-chessgame-moveGroup"),result.appendChild(insertionPoint),moveGroupOpened=!0)}function closeMoveGroup(){moveGroupOpened&&(insertionPoint=result,moveGroupOpened=!1)}void 0!==variation.comment()&&(variation.isLongComment()||openMoveGroup(),insertionPoint.appendChild(buildComment(variation,!0)));var forcePrintMoveNumber=!0;var node=variation.first();for(;void 0!==node;){openMoveGroup(),insertionPoint.appendChild(buildMove(widget,node,forcePrintMoveNumber)),void 0!==node.comment()&&(node.isLongComment()&&closeMoveGroup(),insertionPoint.appendChild(buildComment(node,!1)));for(var hasNonEmptySubVariations=!1,subVariations=node.variations(),k=0;k<subVariations.length;++k){var subVariationElement=buildVariation(widget,subVariations[k],!1,"*");subVariationElement&&((subVariations[k].isLongVariation()?closeMoveGroup:openMoveGroup)(),insertionPoint.appendChild(subVariationElement),hasNonEmptySubVariations=!0)}forcePrintMoveNumber=void 0!==node.comment()||hasNonEmptySubVariations,node=node.next()}isMainVariation&&"*"!==gameResult&&(openMoveGroup(),insertionPoint.appendChild(buildTextElement("span","rpbui-chessgame-result",formatResult(gameResult))));closeMoveGroup();return result}(widget,widget._game.mainVariation(),!0,widget._game.result());if(!mainVariation)return!1;var result="rpbui-chessgame-body";1<mainVariation.childNodes.length&&(result+=" rpbui-chessgame-moreSpace");"none"!==widget.options.navigationBoard&&(result+=" rpbui-chessgame-clickableMoves");"floatLeft"===widget.options.navigationBoard&&(result+=" rpbui-chessgame-indentWithFloatLeft");result=buildElement("div",result);return result.appendChild(mainVariation),result}(widget);switch(currentHeight&&insertionPoint.appendChild(currentHeight),widget.options.navigationBoard){case"floatLeft":case"floatRight":fragment.appendChild(buildElement("div","rpbui-chessgame-"+widget.options.navigationBoard.replace("float","clear")));break;case"below":fragment.appendChild(buildNavigationBox(widget))}widget.element.append(fragment),function(widget){$(".rpbui-chessgame-comment .rpbui-chessgame-diagramAnchor",widget.element).each(function(index,cal){var anchor=$(cal),ctl=anchor.closest(".rpbui-chessgame-comment"),variant=widget._game.variant(),options=ctl.data("position"),csl=ctl.data("csl"),cal=ctl.data("cal"),ctl=ctl.data("ctl"),options={position:variant+":"+options};void 0!==csl&&(options.csl=csl),void 0!==cal&&(options.cal=cal),void 0!==ctl&&(options.ctl=ctl),$.extend(options,widget.options.diagramOptions),RPBChessboard.renderFEN(anchor.empty().removeClass("rpbui-chessgame-diagramAnchor").addClass("rpbui-chessgame-diagram"),options,!0,!0)})}(widget),"none"!==widget.options.navigationBoard&&(function(widget){$(".rpbui-chessgame-move",widget.element).click(function(){updateNavigationBoard(widget,$(this),!0),widget.focus()})}(widget),function(secondMove){$(".rpbui-chessgame-variation",secondMove.element).each(function(index,moves){var moves=$(moves),moves=(moves.is("div")?moves.children(".rpbui-chessgame-moveGroup"):moves).children(".rpbui-chessgame-move"),previousMove=null;moves.each(function(index2,move){move=$(move);null!==previousMove&&(move.data("prevMove",previousMove),previousMove.data("nextMove",move)),previousMove=move})});var initialMove=$(".rpbui-chessgame-initialMove",secondMove.element),secondMove=$(".rpbui-chessgame-variation .rpbui-chessgame-move",secondMove.element);0!==secondMove.length&&((secondMove=secondMove.first()).data("prevMove",initialMove),initialMove.data("nextMove",secondMove))}(widget),$(".rpbui-chessgame-focusField",widget.element).keydown(function(event){"Home"===event.key?widget.goFirstMove():"ArrowLeft"===event.key?widget.goPreviousMove():"ArrowRight"===event.key?widget.goNextMove():"End"===event.key&&widget.goLastMove()}),isNavigationFrame(widget)?($.chessgame.navigationFrameState||($.chessgame.navigationFrameState=filterChessboardOptions($.chessgame.navigationFrameOptions)),widget.navigationBoardState=$.chessgame.navigationFrameState):(widget.navigationBoardState={},Object.assign(widget.navigationBoardState,widget.options.navigationBoardOptions),function(widget){RPBChessboard.renderFEN($(".rpbui-chessgame-navigationBoard",widget.element),widget.navigationBoardState,!0,!0),initializeNavigationButtons(function(buttonClass){return $(buttonClass,widget.element)},function(methodName){widget[methodName](),widget.focus()}),updateNavigationBoard(widget,$(".rpbui-chessgame-initialMove",widget.element),!1)}(widget)),"scrollLeft"!==widget.options.navigationBoard&&"scrollRight"!==widget.options.navigationBoard||(0<(currentHeight=$(".rpbui-chessgame-navigationBox",widget.element).height())?$(".rpbui-chessgame-scrollArea",widget.element).css("height",currentHeight):widget._scrollAreaSizeTimerId=setInterval(function(){var currentHeightTmp=$(".rpbui-chessgame-navigationBox",widget.element).height();0<currentHeightTmp&&($(".rpbui-chessgame-scrollArea",widget.element).css("height",currentHeightTmp),stopScrollAreaSizeTimer(widget))},100)))}else widget.element.append(function(widget){var result=buildElement("div","rpbui-chessgame-error");result.appendChild(buildTextElement("div","rpbui-chessgame-errorTitle",widget._game instanceof kokopu.exception.InvalidPGN?$.chessgame.i18n.PGN_PARSING_ERROR_MESSAGE:widget._game.title)),null!==widget._game.message&&result.appendChild(buildTextElement("div","rpbui-chessgame-errorMessage",widget._game.message));{var errorAt;null!==widget._game.index&&0<=widget._game.index&&(errorAt=buildElement("div","rpbui-chessgame-errorAt"),widget._game.index>=widget._game.pgn.length?errorAt.appendChild(document.createTextNode("Occurred at the end of the string.")):(errorAt.appendChild(document.createTextNode("Occurred at position "+widget._game.index+":")),errorAt.appendChild(buildTextElement("div","rpbui-chessgame-errorAtCode",function(text,pos,p2,e2){var p1=pos-p2,e1="...";return p1<=0&&(p1=0,e1=""),p2=pos+1+e2,e2="...",p2>=text.length&&(p2=text.length,e2=""),(e1+text.substr(p1,p2-p1)+e2).replace(/\n|\t/g," ")+"\n"+new Array(1+e1.length+pos-p1).join(" ")+"^"}(widget._game.pgn,widget._game.index,10,40)))),result.appendChild(errorAt))}return result}(widget))}function buildPlayerNameHeader(rating,group){var title=rating._game.playerName(group);if(void 0===title)return!1;var header=buildElement("div","rpbui-chessgame-"+("w"===group?"white":"black")+"Player");header.appendChild(buildElement("span","rpbui-chessgame-colorTag")),header.appendChild(buildRichTextElement("span","rpbui-chessgame-playerName",title));title=rating._game.playerTitle(group),rating=rating._game.playerElo(group);return void 0===title&&void 0===rating||(group=buildElement("span","rpbui-chessgame-titleRatingGroup"),void 0!==title&&group.appendChild(buildRichTextElement("span","rpbui-chessgame-playerTitle",title)),void 0!==rating&&group.appendChild(buildRichTextElement("span","rpbui-chessgame-playerRating",rating)),header.appendChild(group)),header}function insertPositionInformation(element,ctl,cal){element.setAttribute("data-position",(cal?ctl.initialPosition():ctl.position()).fen());cal=ctl.tag("csl");void 0!==cal&&element.setAttribute("data-csl",cal);cal=ctl.tag("cal");void 0!==cal&&element.setAttribute("data-cal",cal);ctl=ctl.tag("ctl");void 0!==ctl&&element.setAttribute("data-ctl",ctl)}function buildComment(node,isVariation){var result=node.comment().replace(/\[#]/g,'<span class="rpbui-chessgame-diagramAnchor"></span>'),result=buildRichTextElement(node.isLongComment()?"div":"span","rpbui-chessgame-comment",result);return insertPositionInformation(result,node,isVariation),result}function buildMove(widget,node,moveNumberText){var result=buildElement("span","rpbui-chessgame-move");insertPositionInformation(result,node,!1),result.setAttribute("data-position-before",node.positionBefore().fen()),result.setAttribute("data-move-notation",node.notation());var moveNumberClass="rpbui-chessgame-moveNumber"+(moveNumberText||"w"===node.moveColor()?"":" rpbui-chessgame-hidden"),moveNumberText=node.fullMoveNumber()+("w"===node.moveColor()?".":"…");result.appendChild(buildTextElement("span",moveNumberClass,moveNumberText));for(var nag,pieceSymbolTable=widget._pieceSymbolTable,html=node.notation().replace(/[KQRBNP]/g,function(match){return pieceSymbolTable[match]}),nags=node.nags(),k=0;k<nags.length;++k)html+=" "+((nag=nags[k])in SPECIAL_NAGS_LOOKUP?SPECIAL_NAGS_LOOKUP[nag]:"$"+nag);return result.insertAdjacentHTML("beforeend",sanitizeRichText(html)),result}function buildNavigationBox(result){result=buildElement("div","rpbui-chessgame-navigationBox rpbui-chessgame-"+result.options.navigationBoard);return insertNavigationSkeleton(result),result}function insertNavigationSkeleton(element){element.appendChild(buildElement("div","rpbui-chessgame-navigationBoard"));var downloadLink="rpbui-chessgame-navigationButtons";""!==$.chessgame.navigationButtonClass&&(downloadLink+=" "+$.chessgame.navigationButtonClass);var buttons=buildElement("div",downloadLink);function addButton(button,buttonTitle){button=buildElement("div",button);button.setAttribute("title",buttonTitle),buttons.appendChild(button)}element.appendChild(buttons),addButton("rpbui-chessgame-navigationButtonFirst",$.chessgame.i18n.GO_FIRST_MOVE_TOOLTIP),addButton("rpbui-chessgame-navigationButtonPrevious",$.chessgame.i18n.GO_PREVIOUS_MOVE_TOOLTIP),addButton("rpbui-chessgame-navigationButtonNext",$.chessgame.i18n.GO_NEXT_MOVE_TOOLTIP),addButton("rpbui-chessgame-navigationButtonLast rpbui-chessgame-spaceAfter",$.chessgame.i18n.GO_LAST_MOVE_TOOLTIP),addButton("rpbui-chessgame-navigationButtonFlip rpbui-chessgame-spaceAfter",$.chessgame.i18n.FLIP_TOOLTIP),addButton("rpbui-chessgame-navigationButtonDownload rpbui-chessgame-spaceAfter",$.chessgame.i18n.DOWNLOAD_PGN_TOOLTIP);downloadLink=buildElement("a","rpbui-chessgame-blobDownloadLink");downloadLink.setAttribute("href","#"),downloadLink.setAttribute("download","game.pgn"),element.appendChild(downloadLink)}function initializeNavigationButtons(selector,callback){selector(".rpbui-chessgame-navigationButtons").disableSelection(),selector(".rpbui-chessgame-navigationButtonFirst").button({icons:{primary:"ui-icon-seek-first"},text:!1}).click(function(){callback("goFirstMove")}),selector(".rpbui-chessgame-navigationButtonPrevious").button({icons:{primary:"ui-icon-seek-prev"},text:!1}).click(function(){callback("goPreviousMove")}),selector(".rpbui-chessgame-navigationButtonNext").button({icons:{primary:"ui-icon-seek-next"},text:!1}).click(function(){callback("goNextMove")}),selector(".rpbui-chessgame-navigationButtonLast").button({icons:{primary:"ui-icon-seek-end"},text:!1}).click(function(){callback("goLastMove")}),selector(".rpbui-chessgame-navigationButtonFlip").button({icons:{primary:"ui-icon-refresh"},text:!1}).click(function(){callback("flip")}),selector(".rpbui-chessgame-navigationButtonDownload").button({icons:{primary:"ui-icon-extlink"},text:!1}).click(function(){callback("downloadPGN")})}function buildTextElement(type,result,text){result=buildElement(type,result);return result.appendChild(document.createTextNode(text)),result}function buildRichTextElement(type,result,html){result=buildElement(type,result);return result.innerHTML=sanitizeRichText(html),result}function buildElement(result,className){result=document.createElement(result);return""!==className&&(result.className=className),result}function updateNavigationBoard(targetOffset,targetOffsetTop,scrollTarget){var allowScrollDown,scrollArea;null==targetOffsetTop||targetOffsetTop.hasClass("rpbui-chessgame-selectedMove")||(isNavigationFrame(targetOffset)&&0===$("#rpbui-chessgame-navigationFrame").length&&((allowScrollDown=buildElement("div","")).id="rpbui-chessgame-navigationFrame",insertNavigationSkeleton(allowScrollDown),$("body").append(allowScrollDown),$("#rpbui-chessgame-navigationFrame").dialog({create:function(event){$(event.target).parent().css("position","fixed")},resizeStart:function(event){$(event.target).parent().css("position","fixed")},resizeStop:function(event){$(event.target).parent().css("position","fixed")},autoOpen:!1,dialogClass:$.chessgame.navigationFrameClass,width:"auto",close:function(){unselectMove()}}),$("#rpbui-chessgame-navigationFrame").on("dialogresize",function(event,availableHeight){$.chessgame.navigationFrameState.resizeInfo||(availableWidth=$("#rpbui-chessgame-navigationFrame .kokopu-chessboard"),$.chessgame.navigationFrameState.resizeInfo={reservedWidth:availableHeight.originalSize.width-availableWidth.width(),reservedHeight:availableHeight.originalSize.height-availableWidth.height()});var availableWidth=availableHeight.size.width-$.chessgame.navigationFrameState.resizeInfo.reservedWidth,availableHeight=availableHeight.size.height-$.chessgame.navigationFrameState.resizeInfo.reservedHeight;$.chessgame.navigationFrameState.squareSize=RPBChessboard.adaptSquareSize(availableWidth,availableHeight,$.chessgame.navigationFrameState.showCoordinates),RPBChessboard.renderFEN($("#rpbui-chessgame-navigationFrame .rpbui-chessgame-navigationBoard"),$.chessgame.navigationFrameState,!0,!0)}),initializeNavigationButtons(function(buttonClass){return $("#rpbui-chessgame-navigationFrame "+buttonClass)},function(methodName){var gameWidget=$("#rpbui-chessgame-navigationFrameTarget").closest(".rpbui-chessgame");gameWidget.chessgame(methodName),gameWidget.chessgame("focus")})),updateNavigationBoardFlip(targetOffset),function(widget){updateNavigationButton(widget,".rpbui-chessgame-navigationButtonFlip",widget.options.showFlipButton),updateNavigationButton(widget,".rpbui-chessgame-navigationButtonDownload",widget.options.showDownloadButton)}(targetOffset),function(widget,move,playTheMove){playTheMove?(widget.navigationBoardState.position=widget._game.variant()+":"+move.data("positionBefore"),widget.navigationBoardState.move=move.data("moveNotation")):(widget.navigationBoardState.position=widget._game.variant()+":"+move.data("position"),widget.navigationBoardState.move=void 0);widget.navigationBoardState.csl=move.data("csl"),widget.navigationBoardState.cal=move.data("cal"),widget.navigationBoardState.ctl=move.data("ctl"),RPBChessboard.renderFEN(retrieveNavigationBoard(widget),widget.navigationBoardState,!0,!0)}(targetOffset,targetOffsetTop,scrollTarget),function(color,move){unselectMove(isNavigationFrame(color)?null:$(".rpbui-chessgame-selectedMove",color.element)),move.addClass("rpbui-chessgame-selectedMove"),isNavigationFrame(color)&&move.attr("id","rpbui-chessgame-navigationFrameTarget");color=move.css("color");move.css("background-color",color),move.css("color",function(colorString){return.5<$.Color(colorString).lightness()?"black":"white"}(color))}(targetOffset,targetOffsetTop),isNavigationFrame(targetOffset)&&((scrollArea=$("#rpbui-chessgame-navigationFrame")).dialog("isOpen")||(scrollArea.dialog("option","position",{my:"center",at:"center",of:window}),scrollArea.dialog("open")),$(".ui-dialog-title",scrollArea.closest(".ui-dialog")).empty().append(targetOffsetTop.html())),allowScrollDown=!0,(scrollTarget=$(".rpbui-chessgame-selectedMove",targetOffset.element)).hasClass("rpbui-chessgame-initialMove")&&(0===(scrollTarget=$(".rpbui-chessgame-headers",targetOffset.element)).length&&(scrollTarget=$(".rpbui-chessgame-body",targetOffset.element)),allowScrollDown=!1),"scrollLeft"===targetOffset.options.navigationBoard||"scrollRight"===targetOffset.options.navigationBoard?(scrollArea=$(".rpbui-chessgame-scrollArea",targetOffset.element),(targetOffsetTop=scrollTarget.offset().top-scrollArea.offset().top)<0?scrollArea.stop().animate({scrollTop:scrollArea.scrollTop()+targetOffsetTop},200):allowScrollDown&&targetOffsetTop+scrollTarget.height()>scrollArea.height()&&scrollArea.stop().animate({scrollTop:scrollArea.scrollTop()+targetOffsetTop+scrollTarget.height()-scrollArea.height()},200)):"frame"===targetOffset.options.navigationBoard&&((targetOffset=scrollTarget.offset()).top<$(window).scrollTop()?$("html, body").stop().animate({scrollTop:targetOffset.top},200):allowScrollDown&&targetOffset.top+scrollTarget.height()>$(window).scrollTop()+window.innerHeight&&$("html, body").stop().animate({scrollTop:targetOffset.top+scrollTarget.height()-window.innerHeight},200)))}function updateNavigationBoardFlip(widget){widget.navigationBoardState.flip=widget.options.navigationBoardOptions.flip,RPBChessboard.renderFEN(retrieveNavigationBoard(widget),widget.navigationBoardState,!0,!0)}function updateNavigationButton(button,buttonClass,isVisible){button=isNavigationFrame(button)?$("#rpbui-chessgame-navigationFrame "+buttonClass):$(buttonClass,button.element);isVisible?button.show():button.hide()}function isNavigationFrame(widget){return"frame"===widget.options.navigationBoard}function retrieveNavigationBoard(widget){return isNavigationFrame(widget)?$("#rpbui-chessgame-navigationFrame .rpbui-chessgame-navigationBoard"):$(".rpbui-chessgame-navigationBoard",widget.element)}function unselectMove(target){(target=null==target?$("#rpbui-chessgame-navigationFrameTarget"):target).attr("style",null).attr("id",null).removeClass("rpbui-chessgame-selectedMove")}$.widget("rpbchess-ui.chessgame",{options:{pgn:"*",url:"",gameIndex:0,navigationBoard:"none",navigationBoardOptions:{},diagramOptions:{},pieceSymbols:"native",showFlipButton:!0,showDownloadButton:!0},_game:null,_pieceSymbolTable:null,_scrollAreaSizeTimerId:null,_create:function(){this.element.addClass("rpbui-chessgame"),this.options.url=initializeURL(this,this.options.url),this.options.url||(this.options.pgn=initializePGN(this,this.options.pgn)),this.options.pieceSymbols=initializePieceSymbols(this,this.options.pieceSymbols),this.options.navigationBoard=filterNavigationBoard(this.options.navigationBoard),this.options.navigationBoardOptions=filterChessboardOptions(this.options.navigationBoardOptions),this.options.diagramOptions=filterChessboardOptions(this.options.diagramOptions),this.options.showFlipButton=filterBoolean(this.options.showFlipButton,!0),this.options.showDownloadButton=filterBoolean(this.options.showDownloadButton,!0),refresh(this)},_destroy:function(){destroyContent(this),this.element.removeClass("rpbui-chessgame")},_setOption:function(key,value){switch(key){case"url":value=initializeURL(this,value);break;case"pgn":if(this.options.url)return;value=initializePGN(this,value);break;case"pieceSymbols":value=initializePieceSymbols(this,value);break;case"navigationBoard":value=filterNavigationBoard(value);break;case"navigationBoardOptions":case"diagramOptions":value=filterChessboardOptions(value);break;case"showFlipButton":case"showDownloadButton":value=filterBoolean(value,!0)}this.options[key]=value,refresh(this)},goFirstMove:function(){var target=$(".rpbui-chessgame-selectedMove",this.element);if(0!==target.length){for(;void 0!==target.data("prevMove");)target=target.data("prevMove");updateNavigationBoard(this,target,!1)}},goPreviousMove:function(){updateNavigationBoard(this,$(".rpbui-chessgame-selectedMove",this.element).data("prevMove"),!1)},goNextMove:function(){updateNavigationBoard(this,$(".rpbui-chessgame-selectedMove",this.element).data("nextMove"),!0)},goLastMove:function(){var target=$(".rpbui-chessgame-selectedMove",this.element);if(0!==target.length){for(;void 0!==target.data("nextMove");)target=target.data("nextMove");updateNavigationBoard(this,target,!1)}},flip:function(){this.options.navigationBoardOptions.flip=!this.options.navigationBoardOptions.flip,updateNavigationBoardFlip(this)},downloadPGN:function(){var link;this.options.url?window.location.href=this.options.url:(link=new Blob([this.options.pgn],{type:"text/plain"}),null!==dynamicURL&&window.URL.revokeObjectURL(dynamicURL),dynamicURL=window.URL.createObjectURL(link),(link=isNavigationFrame(link=this)?$("#rpbui-chessgame-navigationFrame .rpbui-chessgame-blobDownloadLink"):$(".rpbui-chessgame-blobDownloadLink",link.element)).attr("href",dynamicURL),link.get(0).click())},focus:function(){$(".rpbui-chessgame-focusField",this.element).focus()}})}(RPBChessboard,kokopu,jQuery,sanitizeHtml);